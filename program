#!/bin/bash

# Output help message.
help() {
    filename=$(basename "$0")
    echo "Usage: ${filename} monitoring"
    echo "       monitoring  # catalog which monitoring"
}

# Check the number of parameters.
if [[ $# != 1 ]]
then
    echo "Invalid parameter count."
    help
    exit 1
fi

monitoring=$1 # Мониторимая директория
backup="/home/user/lab6/backup"
ControlSum="/home/user/lab6/ControlSum"
eventlog="/home/user/lab6/eventlog" 

# Если существует директория с эталонными копиями, удаляем её
if [ -d "$backup" ]; then
    rm -r "$backup"
fi
# Создаем директорию для хранения эталонных копий
mkdir -p "$backup"

# Копируем содержимое мониторимой директории в директорию с эталонами
cp "$monitoring"/* /home/user/lab6/backup

# Если существует файл с контрольными суммами, удаляем его
if [ -e "$ControlSum" ]; then
    rm "$ControlSum"
fi

# Создаем новый файл для хранения контрольных сумм
touch "$ControlSum"

# Для каждого файла в директории с эталонами считаем контрольную сумму и записываем в файл
for f in "$backup"/*; do
    sha512sum "$f" >> "$ControlSum"
done

# Если существует файл журнала событий, удаляем его
if [ -e "$eventlog" ]; then
    rm "$eventlog"
fi

# Создаем новый файл журнала событий
touch "$eventlog"
#################


# Check the given file to see if they exist in backup directory.
# If so, check the sha1sum value of given file to see if they have been changed.
# If the file has been changed, recover it from backup folder using cp comand.
# Using date command for outputing current time.
# Using logger command for output log into system event viewer.
checksum() {
    filename=$1
    if [[ ! -f "${backup}/${filename}" ]]
    then
        return 0
    fi
    expected=$(sha256sum "${backup}/${filename}" | awk '{print $1}')
    actual=$(sha256sum "${monitoring}/${filename}" | awk '{print $1}')
    if [ ${actual} != ${expected} ]
    then
        cp -f "${backup}/${filename}" "${monitoring}/${filename}"
        logger -s "$(date '+%Y-%m-%d %H:%M:%S') - ${monitoring}/${filename} has been recovered from ${backup}/${filename}."
    fi
}

# List all files inside monitoring folder and call checksum function.
main() {
    for item in "${monitoring}"/*; do
        if [[ -f "${item}" ]]
        then
            filename=$(basename "${item}")
            checksum "${filename}"
        fi
    done
}

# Call main function for checking each 5 seconds.
while :; do
    main "${monitoring}"
    sleep 5
done
