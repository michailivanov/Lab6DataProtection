#!/bin/bash
#Программа-сервер контроля и восстановления целостности на командном языке bash
dir=$1 #контролируемая директория
if [ /home/user/lab6/Etalon ] #если есть директория, в которой хранятся эталонные копии
then
rm -r Etalon #удаляем
fi
mkdir Etalon #создаем директорию, храняющую эталоны
cp $dir/* Etalon #копируем в нее содержимое нашей директории, которую мы контролируем
if [ /home/user/lab6/ControlSum ] #если есть файл, в котором хранятся контрольные суммы
then
rm ControlSum #удаляем
fi
touch ControlSum #создаем новый  файл, хранящий контрольные суммы
for f in Etalon/* #для каждого файла в директории Etalon мы считываем контрольную сумму
do
sha512sum $f >> ControlSum #записываем контрольную сумму в файл ControlSum
done
if [ /home/user/lab6/eventlog ] #аналогично Etalon и ControlSum
then
rm eventlog
fi
touch eventlog #создаем файл регистрации событий

Контроль и восстановление целостности файла осуществляется в цикле 

while : #Цикл для двумерного массива. Идем по диагонали
do
i=0
j=0 #ищем, где пересекаются контрольная сумма файла и сам файл
while read LINE
do
for f in $dir/* #в цикле перебираются все файлы директории
do
if [ "$j" -eq "$i" ]; then #если номер строки в файле контрольных сумм
совпадает с номером просматриваемого файла
sum1=${LINE:0:128}; #считываем в переменную контрольную сумму 
(обрезаем лишнее)
str=$(sha512sum "$f"); #вычисляем контрольную сумму текущего файла
sum2=${str:0:128};
if [ "$sum1" != "$sum2" ]; then #сравниваем контрольные суммы; 
если не равны
str1=$(date +%d.%m.%y\ %H:%M:%S);
str2="Ошибка! Контрольные суммы файла $f не совпадают!"; 
#выводим сообщение об ошибке в eventlog
echo "$str1$str2" >> eventlog;
string=$f;
str=${string#*${dir}/}; #сформировано имя файла без пути к нему
rm $f; #удаляем файл, который был изменен
cd /.
cd /home/user/lab6/Etalon #вставляем эталонную копию
cp $str /home/user/lab6/$dir
cd /.
cd /home/user/lab6
fi #заканчиваем if, если суммы не равны
fi #заканчиваем if, если  номер строки в файле контрольных сумм 
не совпадает с номером просматриваемого файла

let "j++";
done
let "i++";
let j=0;
done < ControlSum
sleep 5  #цикл каждые 5 секунд
done
exit 0
