#!/bin/bash

# Output help message.
help() {
    filename=$(basename "$0")
    echo "Usage: ${filename} monitoring backup"
    echo "       monitoring  # catalog which monitoring"
    echo "       backup      # catalog for restoring when file changed in monitoring catalog"
}

# Check the number of parameters.
if [[ $# != 2 ]]
then
    echo "Invalid parameter count."
    help
    exit 1
fi

# Check if both parameters are catalog.
monitoring=$1
backup=$2
if [[ ! -d ${monitoring} ]]
then
    echo $1 "is not a directory."
    help
    exit 1
fi
if [[ ! -d ${backup} ]]
then
    echo $2 "is not a directory."
    help
    exit 1
fi

# Check the given file to see if they exist in backup directory.
# If so, check the sha1sum value of given file to see if they have been changed.
# If the file has been changed, recover it from backup folder using cp comand.
# Using date command for outputing current time.
# Using logger command for output log into system event viewer.
checksum() {
    filename=$1
    if [[ ! -f "${backup}/${filename}" ]]
    then
        return 0
    fi
    expected=$(sha256sum "${backup}/${filename}" | awk '{print $1}')
    actual=$(sha256sum "${monitoring}/${filename}" | awk '{print $1}')
    if [ ${actual} != ${expected} ]
    then
        cp -f "${backup}/${filename}" "${monitoring}/${filename}"
        logger -s "$(date '+%Y-%m-%d %H:%M:%S') - ${monitoring}/${filename} has been recovered from ${backup}/${filename}."
    fi
}

# List all files inside monitoring folder and call checksum function.
main() {
    for item in "${monitoring}"/*; do
        if [[ -f "${item}" ]]
        then
            filename=$(basename "${item}")
            checksum "${filename}"
        fi
    done
}

# Call main function for checking each 5 seconds.
while :; do
    main "${monitoring}"
    sleep 5
done
