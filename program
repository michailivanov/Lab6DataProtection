#!/bin/bash
# Скрипт на языке Bash для серверной программы контроля целостности и восстановления файлов.

dir=$1 # Мониторимая директория

# Если существует директория с эталонными копиями, удаляем её
if [ -d /home/user/lab6/Etalon ]; then
    rm -r /home/user/lab6/Etalon
fi

# Создаем директорию для хранения эталонных копий
mkdir /home/user/lab6/Etalon

# Копируем содержимое мониторимой директории в директорию с эталонами
cp "$dir"/* /home/user/lab6/Etalon

# Если существует файл с контрольными суммами, удаляем его
if [ -e /home/user/lab6/ControlSum ]; then
    rm /home/user/lab6/ControlSum
fi

# Создаем новый файл для хранения контрольных сумм
touch /home/user/lab6/ControlSum

# Для каждого файла в директории с эталонами считаем контрольную сумму и записываем в файл
for f in /home/user/lab6/Etalon/*; do
    sha512sum "$f" >> /home/user/lab6/ControlSum
done

# Если существует файл журнала событий, удаляем его
if [ -e /home/user/lab6/eventlog ]; then
    rm /home/user/lab6/eventlog
fi

# Создаем новый файл журнала событий
touch /home/user/lab6/eventlog

# Контроль целостности и восстановление файлов в цикле
while :; do
    i=0
    j=0

    # Перебираем каждую строку в файле контрольных сумм
    while read LINE; do
        # Перебираем все файлы в мониторимой директории
        for f in "$dir"/*; do
            # Проверяем, совпадает ли номер строки в файле контрольных сумм с номером просматриваемого файла
            if [ "$j" -eq "$i" ]; then
                sum1=${LINE:0:128}
                str=$(sha512sum "$f")
                sum2=${str:0:128}

                # Сравниваем контрольные суммы; если не совпадают, записываем сообщение об ошибке в журнал событий
                if [ "$sum1" != "$sum2" ]; then
                    str1=$(date +%d.%m.%y\ %H:%M:%S)
                    str2="Ошибка! Контрольные суммы файла $f не совпадают!"
                    echo "$str1 $str2" >> /home/user/lab6/eventlog

                    # Извлекаем имя файла без пути
                    string=$f
                    str=${string#*${dir}/}

                    # Удаляем измененный файл и восстанавливаем его из эталонной копии
                    rm "$f"
                    cd /home/user/lab6/Etalon
                    cp "$str" "/home/user/lab6/$dir"
                    cd /home/user/lab6
                fi
            fi
        done

        let "j++"
    done < /home/user/lab6/ControlSum

    # Пауза на 5 секунд перед следующей итерацией
    sleep 5
done

# Выход из скрипта
exit 0
